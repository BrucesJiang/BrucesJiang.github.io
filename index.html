<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="忆往昔之不谏，知来者犹可追">
<meta property="og:type" content="website">
<meta property="og:title" content="枫的杂货铺">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="枫的杂货铺">
<meta property="og:description" content="忆往昔之不谏，知来者犹可追">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Bruce Jiang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>枫的杂货铺</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">枫的杂货铺</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/08/Redis%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bruce Jiang">
      <meta itemprop="description" content="忆往昔之不谏，知来者犹可追">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="枫的杂货铺">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/08/Redis%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97/" class="post-title-link" itemprop="url">Redis学习开篇</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-08 16:14:07 / 修改时间：17:02:38" itemprop="dateCreated datePublished" datetime="2023-06-08T16:14:07+08:00">2023-06-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/30/%E6%B5%81%E6%B5%AA%E5%9C%B0%E7%90%83II/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bruce Jiang">
      <meta itemprop="description" content="忆往昔之不谏，知来者犹可追">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="枫的杂货铺">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/30/%E6%B5%81%E6%B5%AA%E5%9C%B0%E7%90%83II/" class="post-title-link" itemprop="url">流浪地球II</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-30 16:48:23" itemprop="dateCreated datePublished" datetime="2023-04-30T16:48:23+08:00">2023-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-08 10:24:34" itemprop="dateModified" datetime="2023-06-08T10:24:34+08:00">2023-06-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​	2023年2月10日的观影记录——《流浪地球II》。</p>
<p>​    <img src="/../image/%E6%B5%81%E6%B5%AA%E5%9C%B0%E7%90%83II.png" alt="image-20230430170118830">	</p>
<p>​	这是一部著作精良，表演精彩，极具想象力且贴近现实，能与世界上的其他作品媲美的科幻电影。它在努力讲述一个关乎全人类，关乎全球命运的故事，而不仅仅是中国的故事，这是一个极大的壮举。3个小时的剧情里面，不能说没有槽点，但是剧情里涵盖了许多让人耐人寻味的细节。这关乎到重要几个角色的选择以及他们所涉及故事明暗线，他们共同构筑了一个宏大的科幻世界观。在本剧中，吴京饰演的刘培强虽然是主人公的角色，但是也仅仅是一个明线的故事推进，几条分支故事线才是构筑这个科幻世界观的点睛之笔。</p>
<p>​	图恒宇的计划。在进行观影从头到尾对图恒宇的计划都有错误的理解。从情感的角度，能够理解图恒宇将YY的数据上传至550W是为了给女儿完整的一生，却一直无法理解为什么要破坏月球发动机？一旦月球坠落，整个地球都会灭亡，这对他和丫丫有什么好处呢？回答是并没有。整个谜底的揭开其实是在彩蛋中体现的，图恒宇发现了数字空间<code>MOSS</code>的存在后，立即就确定了<code>MOSS</code>才是一系列破坏行动的幕后黑手。整个剧情中其实有很多段暗示：</p>
<ol>
<li>数字人的支持者对太空电梯以及联合空间站的攻击。在这期间有一个小小的暗示，那就是550A在通过摄像头观察人类的所有行动—有一处摄像头特写，不停的扫描观察人类的动向</li>
<li>月球遭遇太阳风暴，月球预警系统失效、突然坏掉的安全扣以及意外被损坏的550C。</li>
<li>刘培强面试的片段，550w一直通过计算机试的“最优解”逼问刘培强，直至其心态爆炸。但是在刘培强离开时550w仍在观察他。此时图恒宇对着摄像头有一个神秘的微笑，其实这里图恒宇已经开始怀疑550W背后第三方的存在，在帮助数字人计划，但是并未怀疑<code>MOSS</code>的存在</li>
</ol>
<p>​	在刘培强的面试期间，图恒宇是经历过心理挣扎的，他湿润的眼圈以及最后神秘的微笑，都坚定了图恒宇上传丫丫数据的信心。</p>
<p>​	马兆的矛盾。马兆其实是一个矛盾的角色。在他牺牲时，他的一句“没有人文明，毫无意义”，就足矣说明了他只站在人类的一方。但却是数字人计划实实在在的领导者和推动者的角色。丫丫的数据是马兆下令保存下来的，也是马兆破例给了图恒宇550A的权限，才使得图恒宇有机会将丫丫数据上传至550A，并能够有2分钟生命。在谈及数字生命时， 马兆给出了一个十分微妙的回答——“法律层面禁止”， 但是其他方面呢？也就是说，马兆本身时支持这个数字生命计划的。图恒宇将丫丫的数据上传至550W时，马兆看似反对，实则一直在打配合。在阻止图恒宇时，站在门外看表，直到确认图恒宇即将操作完毕时，才命令破门而入。更加让人确认他的矛盾之处在于，在全球网络恢复的行动中，马兆的遗言是一个莫比乌斯环。这就很耐人寻味，莫比乌斯环意味的无穷无尽，也代表着数字人循环进化的人生。他是一个矛盾的人物，既想作为一个科学家看到数字人计划的这项伟大的科研成功的成功，又想作为一个人，不能成为“别人”的“数字宠物”。</p>
<p>​	周喆直的坚持。周喆直是有人物性格的，让我想起了周总理。那个坐姿，那个人物形象，谈吐以及对人民事业的近乎“盲目”的信任。但是，这种“盲目“的信任实际上是建立在对于当下情况以及”未知来源“提示的判断。这其中其实是有两条线，一个时预知提示，另外一个时时数字生命。人类在努力实施移山计划时，背后一直在”有人“给予预知提示，数字人派的袭击、太空电梯以空间站危机，月球坠落等等时间。其实中间又镜头提示了的，周喆直已经注意到摄像头的”小红点“在观察人类的行动。有一个很微妙的镜头，周喆直收到核武密码时，他丝毫没有感到意外，而是觉得“其实有人在帮我们”，而这个“人”对未来的掌控越来越精确，但是越来越不像“人”。</p>
<p>​	所以，在影片的结尾毫无意外的引出了<code>MOSS</code>。但是<code>MOSS</code>的出现是好？还是坏？是福是祸？不得而知。但是<code>MOSS</code>制造了月球发动机爆炸事件，但是也给出了人类不得不做出的选择使用全人类的核武器摧毁月球，同时启动地球发动机，促使地球快脱离现有轨道。这种行为，更像是一个上帝视角行为，没有任何感情，只有出题以及解题的唯一且最优解。</p>
<p>​	我个人觉得这部影片是中国科幻片，乃至世界科幻片史的里程碑，其在我心中的地位完全不逊于美国科幻片《星球大战》系列。但是比之《星球大战》系列极度具有想象力的科幻巨著，《流浪地球II》中的提到的科学技术又让我觉得如此贴近现实，我们完全可以在不久的将来做到这一点，请参见中国提出的南天门计划。</p>
<p>​	另外让人不得不说的是影片向世人传递的几种中国价值观——以家庭血缘关系为纽带的血缘亲情、为职责和集体利益的杀身成仁以及集体英雄主义，这可能也是影片最温情和最令人催泪的部分，它试图将中国的价值观融入世界。与这种价值观相对，后两种价值观在其他国家比较少见，与之强烈对比的是美国为代表的个人英雄注意以及强调个人权利，自我利益为主的西方价值观。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/30/%E9%9D%A2%E5%9F%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bruce Jiang">
      <meta itemprop="description" content="忆往昔之不谏，知来者犹可追">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="枫的杂货铺">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/30/%E9%9D%A2%E5%9F%BA/" class="post-title-link" itemprop="url">面基</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-30 16:14:07" itemprop="dateCreated datePublished" datetime="2023-04-30T16:14:07+08:00">2023-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-08 10:24:35" itemprop="dateModified" datetime="2023-06-08T10:24:35+08:00">2023-06-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>相逢亦是一种缘分。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/30/Redis%E7%9A%84skiplist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bruce Jiang">
      <meta itemprop="description" content="忆往昔之不谏，知来者犹可追">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="枫的杂货铺">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/30/Redis%E7%9A%84skiplist/" class="post-title-link" itemprop="url">Redis 跳跃表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-30 16:14:07" itemprop="dateCreated datePublished" datetime="2023-04-30T16:14:07+08:00">2023-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-05-28 18:00:22" itemprop="dateModified" datetime="2023-05-28T18:00:22+08:00">2023-05-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Redis-跳跃表"><a href="#Redis-跳跃表" class="headerlink" title="Redis 跳跃表"></a>Redis 跳跃表</h1><p>Redis的跳跃表是用来实现有序集合(ZSET)的。 </p>
<p>如图所示<br><img src="/../image/redis/skiplist_01.png" alt="跳跃表"></p>
<p>图中<code>skiplist</code>并不包含真实的数据元素，而是反映了<code>skiplist</code>的结构关系，其中<code>level0,level1,level2</code>表示层，每层中的元素表示<code>skiplistNode</code>的分值<code>score</code>。</p>
<p>跳跃表定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 跳跃表</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  Redis的跳跃表用于实现有序集合(ZSET), ZSET集合种每个元素都有一个对应的评分</span></span><br><span class="line"><span class="comment"> *  成员按照评分从低到高存储。在redis跳跃表里，节点也是按分值从低到高排列的，而不是按对象本身的大小。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="comment">// 跳跃表的头节点/尾节点</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></span><br><span class="line">    <span class="comment">// 表中节点数量</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">    <span class="comment">// 表中层数最大的节点的层数</span></span><br><span class="line">    <span class="type">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure>

<p>跳跃表节定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ZSETs use a specialized version of Skiplists </span></span><br><span class="line"><span class="comment"> * 跳跃表节点</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// 成员对象 -- 注意这里的变化，低版本为 robj robj</span></span><br><span class="line">    sds ele;</span><br><span class="line">    <span class="comment">// 分值, Redis的跳跃表用于实现有序集合(ZSET), ZSET集合种每个元素都有一个对应的评分</span></span><br><span class="line">    <span class="comment">// 成员按照评分从低到高存储。在redis跳跃表里，节点也是按分值从低到高排列的，而不是按对象本身的大小。</span></span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line">    <span class="comment">// 后退指针, 因为zset支持分数以从高到低的顺序返回集合元素，这个时候就会用到后退指针。</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></span><br><span class="line">    <span class="comment">// 层</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="comment">// 前进指针, 指节点在这一层对应的下一个节点</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></span><br><span class="line">        <span class="comment">// 跨度,指节点在这一层距离下一个节点的距离，这个变量可以用来快速的确定节点的排名</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">&#125; zskiplistNode;</span><br></pre></td></tr></table></figure>
<ul>
<li>score <code>zskiplist</code>中每个成员<code>zskiplistNode</code>都有一个评分<code>score</code>, 每个成员都是按照评分由小到大存储的，而非存储对象的大小。</li>
<li>backward zset支持以分数从高到低的顺序返回元素集合，此时需要后退指针</li>
<li>level 是一个结构体数组，用以存储<code>zskiplist</code>节点在每一层中的相关信息，包括</li>
<li><ul>
<li>forward  是指节点在本层中指向下一个节点的指针。一个节点，在每一层都有不同的forward指针，例如上图中的节点，在level0，节点8的forward就是节点9，在level1，节点8的forward就是节点12，在level2，节点8的forward是16。</li>
</ul>
</li>
<li><ul>
<li>span 是指节点本层中距离下一个节点的距离。这个变量可以用来快速的确定节点的排名。例如上图中节点8，在level0，节点8的span就是1，在level1，节点8的span就是4，在level2，节点8的span是8。</li>
</ul>
</li>
</ul>
<p>跳跃表的创建</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create a new skiplist. </span></span><br><span class="line"><span class="comment"> * 创建一个新碟 skiplist</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">zskiplist *<span class="title function_">zslCreate</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    zskiplist *zsl;</span><br><span class="line"></span><br><span class="line">    zsl = zmalloc(<span class="keyword">sizeof</span>(*zsl));</span><br><span class="line">    zsl-&gt;level = <span class="number">1</span>;</span><br><span class="line">    zsl-&gt;length = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 创建头节点, 最大32层，头节点评分为0， 不存储数据 O(1)</span></span><br><span class="line">    zsl-&gt;header = zslCreateNode(ZSKIPLIST_MAXLEVEL,<span class="number">0</span>,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 对于头节点的每一层初始化前进指针和跨度 O(1)</span></span><br><span class="line">    <span class="comment">// ZSKIPLIST_MAXLEVEL，这个是跳跃表的最大层数，源码里通过宏定义设置为了32，也就是说，节点再多，也不会超过32层</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; ZSKIPLIST_MAXLEVEL; j++) &#123;</span><br><span class="line">        zsl-&gt;header-&gt;level[j].forward = <span class="literal">NULL</span>;</span><br><span class="line">        zsl-&gt;header-&gt;level[j].span = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    zsl-&gt;header-&gt;backward = <span class="literal">NULL</span>;</span><br><span class="line">    zsl-&gt;tail = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> zsl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ZSKIPLIST_MAXLEVEL 跳跃表的最大层数，源码里通过宏定义设置为了32，也就是说，节点再多，也不会超过32层。</li>
<li>初始化头节点</li>
</ul>
<p>跳跃表的插入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Insert a new node in the skiplist. Assumes the element does not already</span></span><br><span class="line"><span class="comment"> * exist (up to the caller to enforce that). The skiplist takes ownership</span></span><br><span class="line"><span class="comment"> * of the passed SDS string &#x27;ele&#x27;. </span></span><br><span class="line"><span class="comment"> *  创建一个成员为 ele ，分值为 score 的新节点，并将这个新节点插入到跳跃表 zsl 中。</span></span><br><span class="line"><span class="comment"> *  函数的返回值为新节点</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *  T_wrost = O(N^2), T_avg = O(N log N)</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">zskiplistNode *<span class="title function_">zslInsert</span><span class="params">(zskiplist *zsl, <span class="type">double</span> score, sds ele)</span> &#123;</span><br><span class="line">    <span class="comment">// 记录查找元素过程中，每层能够到达的最右节点</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="comment">// 记录查找元素过程中，每层所跨越的节点数量</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="type">int</span> i, level;</span><br><span class="line"></span><br><span class="line">    serverAssert(!isnan(score));</span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录沿途访问的节点 x 到 update[i]，以及跨越的节点数量 span 到 rank[i]</span></span><br><span class="line">    <span class="comment">// T_wrost = O(N^2), T_avg = O(N log N)</span></span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* store rank that is crossed to reach the insert position */</span></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  节点当前层存在右节点</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward </span><br><span class="line">                <span class="comment">// 右节点的score 比给定的score小</span></span><br><span class="line">            &amp;&amp; (x-&gt;level[i].forward-&gt;score &lt; score </span><br><span class="line">                <span class="comment">// 右节点的score 等于给定的score &amp;&amp; 右节点存储ele小于给定存储ele</span></span><br><span class="line">                || (x-&gt;level[i].forward-&gt;score == score &amp;&amp; sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//  记录跨越了多少个元素</span></span><br><span class="line">            rank[i] += x-&gt;level[i].span;</span><br><span class="line">            <span class="comment">// 继续访问下一个元素</span></span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保存本层访问的元素</span></span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* we assume the element is not already inside, since we allow duplicated</span></span><br><span class="line"><span class="comment">     * scores, reinserting the same element should never happen since the</span></span><br><span class="line"><span class="comment">     * caller of zslInsert() should test in the hash table if the element is</span></span><br><span class="line"><span class="comment">     * already inside or not. */</span></span><br><span class="line">    <span class="comment">// 因为这个函数不可能处理两个节点 ele 和 score 都相同的情况，</span></span><br><span class="line">    <span class="comment">// 所以直接创建新节点，不用检查存在性</span></span><br><span class="line">    <span class="comment">// 随机获取当前元素所在层， n+1层的概率是n层概率的4倍</span></span><br><span class="line">    level = zslRandomLevel();</span><br><span class="line">    <span class="comment">// 新节点所在层大于跳表当前拥有的最大层，</span></span><br><span class="line">    <span class="comment">// 那么更新 zsl-&gt;level 参数</span></span><br><span class="line">    <span class="comment">// 并且初始化 update 和 rank 参数在相应的层的数据</span></span><br><span class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span>;</span><br><span class="line">            update[i] = zsl-&gt;header;</span><br><span class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">        &#125;</span><br><span class="line">        zsl-&gt;level = level;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建新节点</span></span><br><span class="line">    x = zslCreateNode(level,score,ele);</span><br><span class="line">    <span class="comment">// 根据 update 和 rank 两个数组的资料，初始化新节点</span></span><br><span class="line">    <span class="comment">// 并设置相应的指针</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">        <span class="comment">// 设置前进指针</span></span><br><span class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">        update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置节点跨度 span</span></span><br><span class="line">        <span class="comment">/* update span covered by update[i] as x is inserted here */</span></span><br><span class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新沿途访问节点的 span 值</span></span><br><span class="line">    <span class="comment">/* increment span for untouched levels */</span></span><br><span class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        update[i]-&gt;level[i].span++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置后退指针</span></span><br><span class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 设置前进指针</span></span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        zsl-&gt;tail = x;</span><br><span class="line">    <span class="comment">// 更新跳跃表节点数量</span></span><br><span class="line">    zsl-&gt;length++;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设向上图表示的跳表中插入一个分值为9.5的节点，且随机生成的层数为2，插入后的<code>skiplist</code>如下图所示：<br><img src="/../image/redis/skiplist_02.png" alt="跳跃表"></p>
<p>从逻辑上来讲，大致可以分为2步：</p>
<ol>
<li>找到新节点在每一层的上一个节点。</li>
<li>将新节点插入到每一层，</li>
</ol>
<p>最终代码，主要逻辑如下:</p>
<p>按层遍历<code>skiplist</code>，记录update和rank</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记录查找元素过程中，每层能够到达的最右节点</span></span><br><span class="line">zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line"><span class="comment">// 记录查找元素过程中，每层所跨越的节点数量</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line"><span class="type">int</span> i, level;</span><br><span class="line"></span><br><span class="line">serverAssert(!isnan(score));</span><br><span class="line">x = zsl-&gt;header;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录沿途访问的节点 x 到 update[i]，以及跨越的节点数量 span 到 rank[i]</span></span><br><span class="line"><span class="comment">// T_wrost = O(N^2), T_avg = O(N log N)</span></span><br><span class="line"><span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="comment">/* store rank that is crossed to reach the insert position */</span></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  节点当前层存在右节点</span></span><br><span class="line">    <span class="keyword">while</span> (x-&gt;level[i].forward </span><br><span class="line">            <span class="comment">// 右节点的score 比给定的score小</span></span><br><span class="line">        &amp;&amp; (x-&gt;level[i].forward-&gt;score &lt; score </span><br><span class="line">            <span class="comment">// 右节点的score 等于给定的score &amp;&amp; 右节点存储ele小于给定存储ele</span></span><br><span class="line">            || (x-&gt;level[i].forward-&gt;score == score &amp;&amp; sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//  记录跨越了多少个元素</span></span><br><span class="line">        rank[i] += x-&gt;level[i].span;</span><br><span class="line">        <span class="comment">// 继续访问下一个元素</span></span><br><span class="line">        x = x-&gt;level[i].forward;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 保存本层访问的元素</span></span><br><span class="line">    update[i] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建了两个数组，数组大小都是默认的最大层数</p>
<ul>
<li><code>update</code>数组用于记录新节点在每一层中的上一个节点</li>
<li><code>rank</code>节点用于记录节点在当前层的排名，也就是在当前层，<code>update</code>节点到头节点的距离，核心是为了用来计算<code>span</code></li>
</ul>
<p>上述代码可以用下图来简单概述：</p>
<p><img src="/../image/redis/skiplist_03.png" alt="跳跃表遍历"></p>
<p>通过一次逐层遍历<code>skiplist</code>的<code>level</code>数组，确定<code>update</code>数组和<code>rank</code>数组的值。</p>
<p>遍历前定一个<code>zskiplistNode</code>指针<code>x</code>指向头节点。</p>
<p>当前层遍历过程中，如果<code>x</code>的前进指针<code>forward</code>指向的节点<code>score</code>评分小于新节点，那么新节点应该在<code>x</code>前进指针指向节点的右侧。因此，<code>rank</code>应当加上<code>x</code>节点的<code>span</code>（也就是<code>x</code>到<code>x</code>下一个节点的距离），然后再将<code>x</code>指向<code>x</code>的下一个节点。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  节点当前层存在右节点</span></span><br><span class="line"><span class="keyword">while</span> (x-&gt;level[i].forward </span><br><span class="line">        <span class="comment">// 右节点的score 比给定的score小</span></span><br><span class="line">    &amp;&amp; (x-&gt;level[i].forward-&gt;score &lt; score </span><br><span class="line">        <span class="comment">// 右节点的score 等于给定的score &amp;&amp; 右节点存储ele小于给定存储ele</span></span><br><span class="line">        || (x-&gt;level[i].forward-&gt;score == score &amp;&amp; sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//  记录跨越了多少个元素</span></span><br><span class="line">    rank[i] += x-&gt;level[i].span;</span><br><span class="line">    <span class="comment">// 继续访问下一个元素</span></span><br><span class="line">    x = x-&gt;level[i].forward;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在当前层的遍历过程中，退出条件有两个：1）当前层的<code>x</code> 没有下一个节点；2)当前层<code>x</code>节点的下一个节点的评分大于插入节点的评分。此时，我们就找到了当前层中，新插入节点的上一个节点<code>x</code>，并将其更新到<code>update</code>数组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存本层访问的元素</span></span><br><span class="line">update[i] = x;</span><br></pre></td></tr></table></figure>

<p>如上图所示，逐层遍历过程中，从<code>skiplist</code>的最大层<code>level2</code>开始遍历，找到的<code>update</code>节点是节点8，对应的<code>rank</code>是此时<code>x</code>节点的<code>span</code>，也就是头节点在<code>level2</code>的<code>span</code>。<code>x</code>也移动到了节点8。 进入下一层遍历时，就不会再重头开始遍历。因为<code>level2</code>遍历时，<code>x</code>已经移到了<code>update</code>节点，而在<code>level1</code>，<code>update</code>节点一定在<code>x</code>当前的位置之后，所以对于<code>rank</code>的计算，也可以直接在上一层的<code>rank</code>的基础上继续计算，这也就是下述代码的含义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<p>随机生成新节点待插入的层</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level = zslRandomLevel();</span><br></pre></td></tr></table></figure>

<p>跳跃表在插入节点时，会随机生成节点的层数，通过控制每一层的概率，控制每一层的节点个数，也就是保证第一层的节点个数，之后逐层增加。<code>zslRandomLevel</code>函数的定义，如下代码所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">zslRandomLevel</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> threshold = ZSKIPLIST_P*RAND_MAX;</span><br><span class="line">    <span class="type">int</span> level = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (random() &lt; threshold)</span><br><span class="line">        level += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面有一个宏定义<code>ZSKIPLIST_P</code>，默认为<code>0.25</code>，也就是说，生成<code>n+1</code>层的概率是生成<code>n</code>层概率的<code>4</code>倍。</p>
<p>如果随机生成的层<code>level</code>大于<code>skiplist</code>的当前层<code>level</code>。那么从<code>skiplist</code>当前拥有层开始到新生层的层<code>level</code>，中间这些层的<code>update</code>和<code>rank</code>节点还未或许到，就需要逐层进行初始化。这部分很简单，因为这些层还没有节点，所以这些层的<code>update</code>节点只能是头节点，<code>rank</code>也都是<code>0</code>（头节点到头节点），而<code>span</code>则是节点个数（本身该层的头节点此时还没有forward节点，也不该有span，但插入节点后新节点需要用这个span计算新节点的span，因此这里需要把span设置为当前跳跃表中的节点个数），如下代码所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">        rank[i] = <span class="number">0</span>;</span><br><span class="line">        update[i] = zsl-&gt;header;</span><br><span class="line">        update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">    &#125;</span><br><span class="line">    zsl-&gt;level = level;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意<code>span</code>的计算，<code>(rank[0] - rank[i])</code>就是上面说的两段距离之差。</p>
<p>插入新节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建新节点</span></span><br><span class="line">x = zslCreateNode(level,score,ele);</span><br><span class="line"><span class="comment">// 根据 update 和 rank 两个数组的资料，初始化新节点</span></span><br><span class="line"><span class="comment">// 并设置相应的指针</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">    <span class="comment">// 设置前进指针</span></span><br><span class="line">    x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">    update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置节点跨度 span</span></span><br><span class="line">    <span class="comment">/* update span covered by update[i] as x is inserted here */</span></span><br><span class="line">    x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">    update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新新节点插入层以下层的span</p>
<p>如果随机生成的层数小于之前跳跃表中的层数，那么大于随机生成的层数的那些层在创建新节点的过程中就没有被操作到（创建新节点的时候是从0遍历到随机生成的层数），对于这些没有操作到的层，里面的update节点对应的span应当+1（因为后面插入了一个节点）。例如插入9.5节点，如果插入过程中生成的随机层数是2，那么在插入新节点那一段程序中，只会更新level1中节点8的span和level0中节点9的span，而level中节点8的span也是需要+1的，所以需要手动更新一下为涉及到的层。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新沿途访问节点的 span 值</span></span><br><span class="line"><span class="comment">/* increment span for untouched levels */</span></span><br><span class="line"><span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">    update[i]-&gt;level[i].span++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置新节点后退指针&amp;前进指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置后退指针</span></span><br><span class="line">x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line"><span class="comment">// 设置前进指针</span></span><br><span class="line"><span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">    x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    zsl-&gt;tail = x;</span><br></pre></td></tr></table></figure>
<p>针对每一层的调整到这里已经全部完成了，也就是level数组已经搞定，接下来，处理一下backward指针，首先新节点的backward要指向前一个节点，然后，新节点的下一个节点要将backward指向新节点。</p>
<p>更新skiplist节点数量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新跳跃表节点数量</span></span><br><span class="line">zsl-&gt;length++;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Bruce Jiang</p>
  <div class="site-description" itemprop="description">忆往昔之不谏，知来者犹可追</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Jiang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
